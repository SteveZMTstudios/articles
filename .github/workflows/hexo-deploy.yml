name: Hexo Deploy

on:
  pull_request_target:
    types: [closed]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  pull-requests: write  # 添加PR权限

jobs:
  build-deploy:
    # 只在PR被合并时执行
    if: github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Git
      run: |
        git config --global user.name 'stevezmtstudios'
        git config --global user.email '98326195+SteveZMTstudios@users.noreply.github.com'

    
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.ACTIONS_DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '22'  # 你可以根据需要修改 Node.js 版本

    - name: Install dependencies (ci)
      run: |
        # Use npm ci to install exact versions from package-lock.json for reproducibility
        npm ci || npm install

    - name: Install Theme dependencies (if any)
      run: |
        # If the theme has its own package.json, install its deps. This is conditional and safe.
        if [ -f themes/default/package.json ]; then
          pushd themes/default
          npm ci || npm install
          popd
        fi

    - name: Verify Theme Files
      run: |
        if [ ! -d "themes/default/layout" ]; then
          echo "Theme layout files are missing"
          exit 1
        fi

    - name: Clean, Build and Deploy (match local)
      run: |
        # Run the exact commands you use locally to ensure consistency
        npm run clean && npm run build && npm run deploy