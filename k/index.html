<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>老史尬侃 - 兼容模式</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#fff;color:#111;margin:0;padding:10px}
    header{margin-bottom:10px}
    h1{font-size:18px;margin:0 0 6px}
    #list{margin:0;padding:0;list-style:none}
    #list li{padding:8px;border-bottom:1px solid #eee}
  a.item{color:#006;text-decoration:none}
  a.item:hover{text-decoration:underline}
  .summary{color:#333;margin-top:6px;font-size:13px}
  .categories{color:#666;margin-top:6px;font-size:12px}
  #content{margin-top:12px;padding:8px;border:1px solid #ddd;background:#fafafa}
  .meta{color:#666;font-size:12px}
  .loading{color:#999}
    @media (max-width:400px){h1{font-size:16px}}
  </style>
</head>
<body>
  <header>
    <h1>老史尬侃（兼容模式）</h1>
    <p id="compat-banner" style="background:#ff9800;padding:6px;margin:0;">您的浏览器不支持现代特性，无法正确加载页面内容，已切换到兼容模式。</p>
    <script>
    (function(){

      try{
        var banner = document.getElementById('compat-banner');
        if(!banner) return;

        function hasArrayFind(){ try{ return typeof Array.prototype.find === 'function'; }catch(e){return false;} }
        function hasQS(){ try{ return typeof document.querySelector === 'function'; }catch(e){return false;} }
        function hasAE(){ try{ return typeof window.addEventListener === 'function'; }catch(e){return false;} }

        var modernFeatures = {
          Promise: (typeof Promise !== 'undefined' && typeof Promise.resolve === 'function'),
          fetch: (typeof fetch === 'function'),
          ObjectAssign: (typeof Object.assign === 'function'),
          ArrayFind: hasArrayFind(),
          querySelector: hasQS(),
          addEventListener: hasAE(),
          URLSearchParams: (typeof URLSearchParams === 'function')
        };


        var allOk = true;
        for(var k in modernFeatures){ if(!modernFeatures[k]){ allOk = false; break; } }
        if(!allOk) return;


        try{ banner.style.background = '#4CAF50'; banner.style.color = '#fff'; }catch(e){}
        try{ banner.textContent = '您的浏览器支持访问更加先进的页面，即将跳转到主站...'; }catch(e){}
        setTimeout(function(){ try{ location.replace('/'); }catch(e){} }, 500);
      }catch(e){}
    })();
    </script>
    <p>部分博客内嵌脚本特性可能无法使用。</p>
    <p><a href="https://browser-update.org/update-browser.html">更新浏览器（推荐）</a>以获取最佳体验和页面优化。或<a href="/?persist_no_k=1">仍然访问完整版</a></p>
    <p><a href="/about/?persist_no_k=1">关于</a> | <a href="/friends/?persist_no_k=1">友链</a> | <a href="/timeline/?persist_no_k=1">时间线</a> | <a href="/atom.xml">RSS</a> | <a href="http://stevezmt.top">主站</a> <a href="https://key.stevezmt.top/">GPG密钥</a> | <a href="mailto:admin@stevezmt.top">电子邮件到 admin@stevezmt.top</a> </p>
    <hr />
  </header>

  <div id="app">
    <div id="status" class="loading">正在加载文章…</div>
    <ul id="list" role="list"></ul>
    <div id="content" aria-live="polite"><a href="/about/?persist_no_k=1">关于</a> | <a href="/friends/">友链</a> | <a href="/timeline/?persist_no_k=1">时间线</a> | <a href="/atom.xml">RSS</a> | <a href="http://stevezmt.top">主站</a> <a href="https://key.stevezmt.top/">GPG密钥</a> | <a href="mailto:admin@stevezmt.top">电子邮件</a> </div>
  </div>

  <noscript>
    <p style="background:#ff9800;padding:6px;margin:0;">浏览器未启用 JavaScript。遗憾的是，你必须启用它才能查看文章列表和内容。</p>
    <p>你也可以直接访问 <a href="/atom.xml">/atom.xml</a> 阅读原始订阅。</p>
  </noscript>

  <script data-cfasync="false">



  if (!Function.prototype.bind) {
    var status = document.getElementById('status');
    if (status) status.innerHTML = '您的浏览器不支持 Function.prototype.bind，无法加载内容。请升级浏览器或使用新版 Edge/Chrome/Firefox。';
    throw new Error('Function.prototype.bind not supported');
  }

  (function(){
    var status = document.getElementById('status');
    var listEl = document.getElementById('list');
    var contentEl = document.getElementById('content');

    function createXHR(){
      if(window.XMLHttpRequest) return new XMLHttpRequest();
      try { return new ActiveXObject('Msxml2.XMLHTTP'); } catch(e){}
      try { return new ActiveXObject('Microsoft.XMLHTTP'); } catch(e){}
      return null;
    }

    function parseXMLString(str){

      if(window.DOMParser){
        try{ return (new DOMParser()).parseFromString(str,'application/xml'); }catch(e){}
      }

      var doc = null;
      try{
        doc = new ActiveXObject('Microsoft.XMLDOM');
        doc.async = false;
        doc.loadXML(str);
        return doc;
      }catch(e){}
      return null;
    }

    function getText(node){
      if(!node) return '';
      return node.textContent || node.text || '';
    }

    function getFirstChildByName(node, name){
      if(!node) return null;
      var children = node.childNodes;
      for(var i=0;i<children.length;i++){
        var n = children[i];
        if(n.nodeType===1 && (n.localName===name || n.nodeName===name)) return n;
      }
      return null;
    }

    function safeInnerHTML(el, html){

      try{ el.innerHTML = html; }catch(e){

        while(el.firstChild) el.removeChild(el.firstChild);
        el.appendChild(document.createTextNode(html));
      }
    }

    function renderEntries(doc){

      var entries = doc.getElementsByTagName && doc.getElementsByTagName('entry');
      if(!entries || entries.length===0){

        var all = doc.getElementsByTagName('*');
        var tmp = [];
        for(var i=0;i<all.length;i++){
          if((all[i].localName||all[i].nodeName||'').toLowerCase()==='entry') tmp.push(all[i]);
        }
        entries = tmp;
      }

      if(!entries || entries.length===0){ status.textContent = '未找到文章条目或解析失败。'; return; }
      status.style.display = 'none';

      for(var i=0;i<entries.length;i++){
        (function(entry){
          var titleNode = getFirstChildByName(entry,'title');
          var linkNode = getFirstChildByName(entry,'link');
          var idNode = getFirstChildByName(entry,'id');
          var publishedNode = getFirstChildByName(entry,'published') || getFirstChildByName(entry,'updated');
          var summaryNode = getFirstChildByName(entry,'summary');
          var contentNode = getFirstChildByName(entry,'content');

          var title = getText(titleNode) || '（无标题）';
          var href = '';
          if(linkNode){ href = linkNode.getAttribute && linkNode.getAttribute('href') || getText(linkNode) || ''; }
          var id = getText(idNode) || href || '';
          var published = getText(publishedNode) || '';

          var li = document.createElement('li');
          var a = document.createElement('a');
          a.href = href || '#';
          a.className = 'item';
          a.setAttribute('data-id', id);
          a.setAttribute('data-href', href);
          a.setAttribute('role','link');
          a.appendChild(document.createTextNode(title));

          var meta = document.createElement('div');
          meta.className = 'meta';
          meta.appendChild(document.createTextNode(published));


          var summaryText = '';
          try{ if(summaryNode) summaryText = (summaryNode.textContent || (summaryNode.firstChild && summaryNode.firstChild.nodeValue) || ''); }catch(e){}
          var summaryDiv = document.createElement('div'); summaryDiv.className = 'summary'; if(summaryText) safeInnerHTML(summaryDiv, summaryText);


          var cats = [];
          try{
            var catNodes = entry.getElementsByTagName && entry.getElementsByTagName('category');
            if(catNodes && catNodes.length>0){ for(var ci=0;ci<catNodes.length;ci++){ try{ var t = catNodes[ci].getAttribute && catNodes[ci].getAttribute('term') || catNodes[ci].textContent || ''; if(t) cats.push(t); }catch(e){} } }
            else {

              var allc = entry.getElementsByTagName('*');
              for(var ac=0;ac<allc.length;ac++){ if((allc[ac].localName||allc[ac].nodeName||'').toLowerCase()==='category'){ var t2 = allc[ac].getAttribute && allc[ac].getAttribute('term') || allc[ac].textContent||''; if(t2) cats.push(t2); } }
            }
          }catch(e){}
          var catsDiv = document.createElement('div'); catsDiv.className='categories'; if(cats.length) catsDiv.appendChild(document.createTextNode('分类：' + cats.join(', ')));

          li.appendChild(a);
          li.appendChild(meta);
          if(summaryText) li.appendChild(summaryDiv);
          if(cats.length) li.appendChild(catsDiv);
          listEl.appendChild(li);

          a.onclick = function(evt){
            try{ if(evt && evt.preventDefault) evt.preventDefault(); }catch(e){}

            var params = [];
            try{ if(id) params.push('id=' + encodeURIComponent(id)); }catch(e){}
            try{ if(href) params.push('href=' + encodeURIComponent(href)); }catch(e){}
            try{ if(title) params.push('title=' + encodeURIComponent(title)); }catch(e){}
            var q = params.length? ('?' + params.join('&')) : '';
            var target = '/k/content.html' + q;

            location.href = target;
            return false;
          };
        })(entries[i]);
      }
    }

    function loadExternal(url, cb){
      var xhr = createXHR(); if(!xhr){ cb(false); return; }
      try{
        xhr.open('GET', url, true);

        xhr.onreadystatechange = function(){
          if(xhr.readyState===4){
            if((xhr.status>=200 && xhr.status<300) || xhr.status===0){
              cb(true, xhr.responseText);
            } else cb(false, xhr.status);
          }
        };
        xhr.send(null);
      }catch(e){ cb(false); }
    }

    function loadFeed(){
      var xhr = createXHR();
      if(!xhr){ status.textContent = '此浏览器不支持网络请求。'; return; }
      try{
        xhr.open('GET','/atom.xml',true);

        try{ xhr.overrideMimeType && xhr.overrideMimeType('text/xml'); }catch(e){}
        xhr.onreadystatechange = function(){
          if(xhr.readyState===4){
            if((xhr.status>=200 && xhr.status<300) || xhr.status===0){
              var doc = xhr.responseXML;
              if(!doc || !doc.documentElement){

                doc = parseXMLString(xhr.responseText || xhr.response);
              }
              if(doc) renderEntries(doc);
              else status.textContent = '无法解析 atom.xml';
            } else {
              status.textContent = '加载 atom.xml 失败，HTTP 状态：' + xhr.status;
            }
          }
        };
        xhr.send(null);
      }catch(e){ status.textContent = '请求 atom.xml 时发生错误'; }
    }


    if(document.readyState==='loading'){
      try{ document.addEventListener('DOMContentLoaded', loadFeed, false); }catch(e){ window.onload = loadFeed; }
    } else loadFeed();

  })();
  </script>
</body>
</html>
