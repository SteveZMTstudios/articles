<script data-pjax>
  document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('.mdui-card-content a');
    
    links.forEach(link => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('http') && 
          !href.includes('blog.stevezmt.top') && 
          !href.includes('stevezmt.top') && 
          !href.includes('localhost')) {
        link.href = `/redirect?goto=${encodeURIComponent(href)}`;
      }
    });
  });
  </script>

<% if (page.photos && page.photos.length) { %>
  <%- css(theme.gallery.fancybox_css) %>
  <article class="mdui-row-xs-2 mdui-row-sm-3 mdui-row-md-4 mdui-row-lg-5 mdui-row-xl-6 mdui-grid-list" style="margin: 0 auto;">
    <% page.photos.forEach(function (photo) { %>
      <div class="mdui-col">
        <div class="mdui-grid-tile mdui-hoverable">
          <a data-fancybox="gallery" href="<%- url_for(photo) %>">
            <img src="/images/grey.png" class="lazyload" data-original="<%- url_for(photo) %>" style="height: 160px; border-radius: 2px;">
          </a>
        </div>
      </div>
    <% }) %>
  </article>
  <%- js([theme.gallery.jquery_js, theme.gallery.lazyload_js, theme.gallery.fancybox_js]) %>
  <script data-pjax>$("#main article img.lazyload").lazyload({effect:"fadeIn"});</script>
<% } else if (page.timeline && site.posts.length) { %>
  <style>
    #timeline{max-width:750px;margin:0 auto;padding:0 8px}
    #timeline h2{margin:.6em 0}
    #timeline a{position:relative;display:-webkit-box;display:-ms-flexbox;display:flex;padding:8px 0;text-decoration:none;color:inherit;word-break:break-word;-webkit-transition:all .28s ease;transition:all .28s ease}
    #timeline a:before{content:'';position:absolute;top:0;left:24px;z-index:1;width:2px;height:8px;background:#9c27b0}
    #timeline a:after{content:'';position:absolute;top:24px;left:24px;z-index:1;width:2px;height:calc(100% - 24px);background:#9c27b0}
    #timeline a span:first-child{-ms-flex-negative:0;flex-shrink:0;width:64px;margin-left:48px}
    #timeline a span:first-child:before{content:'';position:absolute;top:8px;left:17px;z-index:2;width:16px;height:16px;border-radius:8px;background:#9c27b0;-webkit-transform:scale(.5);transform:scale(.5);-webkit-transition:all .28s ease;transition:all .28s ease}
    #timeline a:hover{background-color:rgba(0,0,0,.1)}
    .mdui-theme-layout-dark #timeline a:hover{background-color:rgba(255,255,255,.1)}
    #timeline a:hover span:first-child:before{-webkit-transform:scale(.8);transform:scale(.8)}
    #timeline a .mdui-icon{padding-left:8px;font-size:1em;color:#9c27b0;-webkit-transform:scale(1.5);transform:scale(1.5)}
  </style>
  <article id="timeline">
    <% var year = -1 %>
    <% site.posts.sort('date', -1).each(function(post) { %>
      <% post.year = date(post.date, 'YYYY') %>
      <% if (post.year && post.year !== year) { %>
        <% year = post.year %>
        <h2><%= year %></h2>
      <% } %>
      <a href="<%- url_for(post.link || post.path) %>"<% if (post.link) { %> target="_blank"<% } %>>
        <span><%= date(post.date, 'MM-DD') %></span>
        <span><%= post.title %><% if (post.sticky || post.top) { %><i class="mdui-icon material-icons" translate="no">fiber_pin</i><% } %></span>
      </a>
    <% }) %>
  </article>
<% } else if (page.tagcloud && site.tags.length) { %>
  <style>
    #tagcloud a{margin:0 8px;padding:8px 0;line-height:40px;white-space:nowrap;text-decoration:none;opacity:.87;-webkit-transition:all .2s cubic-bezier(.4,0,.2,1);-o-transition:all .2s cubic-bezier(.4,0,.2,1);transition:all .2s cubic-bezier(.4,0,.2,1)}
    #tagcloud a:hover{opacity:1;text-shadow:1px 1px 3px #444}
  </style>
  <article id="tagcloud" class="mdui-text-center">
    <%- tagcloud({min_font: 16, max_font: 35, amount: 9999, color: true, start_color: '#3f51b5', end_color: '#ff4081'}) %>
  </article>
<% } else if (page.layout === 'custom') { %>
  <%- page.content %>
<% } else { %>
  <%- css(theme.gallery.fancybox_css) %>
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <style>#main article .mdui-card-content .text-center{text-align:center!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="<%- page.thumbnail || '/images/random/material-' + (Math.round(Math.random() * 18) + 1) + '.png' %>" style="max-height: 240px; width: 100%; object-fit: cover;" alt="thumbnails">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
            <div class="mdui-card-primary-title"><h1 style="margin: 0; font-size: inherit; font-weight: inherit;"><%= page.title %></h1></div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont" translate="no">&#xe697;</i> <%- date(page.date) %> / <i class="iconfont" translate="no">&#xe601;</i> <%= page.author || config.author %><% if (theme.busuanzi.page && page.count !== false ) { %> &nbsp;&nbsp; <span id="busuanzi_container_page_pv" style="display: none;"><i class="iconfont" translate="no">&#xe7fd;</i> <span id="busuanzi_value_page_pv"></span></span><% } %></div>
        </div>
      </div>
      <div class="mdui-card-menu">
        <% if (page.qrcode !== false) { %>
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#qrcode', align: 'right'}"><i class="mdui-icon material-icons" translate="no">devices</i></button>
          <ul class="mdui-menu" id="qrcode">
            <% if (theme.qrcode.caption) { %>
              <li class="mdui-menu-item"><a class="mdui-text-center mdui-ripple"><%= theme.qrcode.caption %></a></li>
            <% } %>
            <li class="mdui-menu-item" disabled>
              <% if (theme.qrcode.use === 'plugin') { %>
                <img src="<%- qrcode(page.permalink, {margin: 2}) %>">
              <% } else { %>
                <img src="<% if (page.lang === 'zh-CN') { %>//api.qrserver.com/v1/create-qr-code/?size=300x300&data=<%- page.permalink %><% } else { %>//chart.googleapis.com/chart?cht=qr&chs=246x246&chl=<%- page.permalink %>&chld=M|2<% } %>">
              <% } %>
            </li>
          </ul>
        <% } %>
        <% if (page.share_menu !== false) { %>
          <button class="mdui-btn mdui-btn-icon mdui-text-color-white" mdui-menu="{target: '#share_menu', align: 'right'}"><i class="mdui-icon material-icons" translate="no">share</i></button>
          <ul class="mdui-menu" id="share_menu">
            <li class="mdui-menu-item">
              <a href="javascript:void(0);" class="mdui-ripple" onclick="copyToClipboard('<%- page.permalink %>');"><%= __('share.copy_link') %></a>
            </li>

            <script data-pjax>
              function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(function() {
                  mdui.snackbar({message: '已复制链接!', position: 'top', buttonText: '好'});
                }, function(err) {
                  console.error('Could not copy text: ', err);
                });
              }
            </script>
            <li class="mdui-menu-item">
              <a href="https://service.weibo.com/share/share.php?appkey=&title=<%= page.title %>&url=<%- page.permalink %>&pic=<%- config.url + url_for(theme.favicon) %>&searchPic=false&style=simple" target="_blank" class="mdui-ripple"><%= __('share.weibo') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://twitter.com/intent/tweet?text=<%= page.title %>&url=<%- page.permalink %>&via=<%= config.author %>" target="_blank" class="mdui-ripple"><%= __('share.twitter') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.facebook.com/sharer/sharer.php?u=<%- page.permalink %>" target="_blank" class="mdui-ripple"><%= __('share.facebook') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://plus.google.com/share?url=<%- page.permalink %>" target="_blank" class="mdui-ripple"><%= __('share.google_plus') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://www.linkedin.com/shareArticle?mini=true&url=<%- page.permalink %>&title=<%= page.title %>" target="_blank" class="mdui-ripple"><%= __('share.linkedin') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://connect.qq.com/widget/shareqq/index.html?site=<%= config.title %>&title=<%= page.title %>&pics=<%- config.url + url_for(theme.favicon) %>&url=<%- page.permalink %>" target="_blank" class="mdui-ripple"><%= __('share.qq') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="https://telegram.me/share/url?url=<%- page.permalink %>&text=<%= page.title %>" target="_blank" class="mdui-ripple"><%= __('share.telegram') %></a>
            </li>
            <li class="mdui-menu-item">
              <a href="javascript:void(0);" class="mdui-ripple" onclick="sharePageviaSystem();"><%= __('share.system') %></a>
            </li>

            <script data-pjax>
              function sharePageviaSystem() {
                if (navigator.share) {
                  navigator.share({
                    title: '<%= page.title %>',
                    text: '<%- page.excerpt.replace(/(<([^>]+)>)/gi, "") %>',
                    url: '<%- page.permalink %>'
                  }).then(() => {
                    mdui.snackbar({message: '感谢分享！', position: 'top'});
                  }).catch(console.error);
                } else {
                  mdui.snackbar({message: '您的浏览器不支持此方式。', position: 'top', buttonText: '好吧'});
                }
              }
            </script>
          </ul>
        <% } %>
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <%- page.content %>
      <script data-pjax>
        (function(){
          function attachCopyButtons(){
            var blocks = document.querySelectorAll('.mdui-card-content figure.highlight, .mdui-card-content pre');
            blocks.forEach(function(block){

              if(block.matches('pre') && block.closest('figure.highlight')) return;
              if(block.querySelector(':scope > .code-toolbar')) return;
              block.classList.add('codeblock-wrapper');
              if(!block.style.position || block.style.position === 'static') block.style.position = 'relative';
              if(block.matches('figure.highlight') && !block.querySelector('figcaption')) {
                block.classList.add('codeblock-pad-top');
              }
              if(block.matches('pre') && !block.closest('figure.highlight')) {
                block.classList.add('codeblock-pad-top');
              }

              if(!block.querySelector(':scope > .code-content-wrap')) {
                var wrap = document.createElement('div');
                wrap.className = 'code-content-wrap';
                var toMove = [];
                Array.from(block.childNodes).forEach(function(n){
                  if(n.nodeType === 1 && (n.classList && (n.classList.contains('code-toolbar')))) return;
                  toMove.push(n);
                });
                toMove.forEach(function(n){ wrap.appendChild(n); });
                block.appendChild(wrap);

                requestAnimationFrame(function(){
                  wrap.style.maxHeight = wrap.scrollHeight + 'px';
                });
              }
              var toolbar = document.createElement('div');
              toolbar.className = 'code-toolbar';

              var copyBtn = document.createElement('button');
              copyBtn.className = 'copy-btn mdui-btn mdui-ripple';
              copyBtn.type='button';
              copyBtn.setAttribute('aria-label','复制代码');
              copyBtn.innerHTML = '<i class="mdui-icon material-icons" translate="no">content_copy<\/i>';
              copyBtn.addEventListener('click', function(){ copyText(copyBtn); });
              toolbar.appendChild(copyBtn);

              var collapseBtn = document.createElement('button');
              collapseBtn.className = 'collapse-btn mdui-btn mdui-ripple';
              collapseBtn.type='button';
              collapseBtn.setAttribute('aria-label','折叠代码');
              collapseBtn.innerHTML = '<i class="mdui-icon material-icons" translate="no">expand_less<\/i>';
              collapseBtn.addEventListener('click', function(){ toggleCollapse(block, collapseBtn); });
              toolbar.appendChild(collapseBtn);

              var lang = detectLanguage(block) || 'Code';
              var langSpan = document.createElement('span');
              langSpan.className = 'code-lang-badge';
              langSpan.textContent = lang;
              toolbar.appendChild(langSpan);
              block.appendChild(toolbar);
            });
          }

          function detectLanguage(block){
            try {
              var cls = block.className || '';
              var m = cls.match(/highlight\s+([a-zA-Z0-9_+-]+)/);
              if(m && m[1]) return normalizeLang(m[1]);
              var code = block.querySelector('code');
              if(code){
                for(var i=0;i<code.classList.length;i++){
                  var c = code.classList[i];
                  if(/^language-/.test(c)) return normalizeLang(c.replace(/^language-/,''));
                  if(/^lang-/.test(c)) return normalizeLang(c.replace(/^lang-/,''));
                }
              }
              return 'Code';
            } catch(e){ return 'Code'; }
          }

          function normalizeLang(l){
            l = l.toLowerCase();
            var map = {js:'JavaScript',javascript:'JavaScript',ts:'TypeScript',py:'Python',py3:'Python',bash:'Bash',sh:'Shell',shell:'Shell',yml:'YAML',yaml:'YAML',md:'Markdown',markdown:'Markdown',json:'JSON',html:'HTML',css:'CSS',csharp:'C#',cs:'C#',cpp:'C++',c:'C',java:'Java',go:'Go',rust:'Rust'};
            return map[l] || l.charAt(0).toUpperCase()+l.slice(1);
          }

          window.copyText = function(el){
            if(!el) return;
            var container = el.closest('figure.highlight, pre');
            if(!container){ feedback(false, el); return; }

            var codeArea = container.querySelector('td.code') || container.querySelector('pre code') || container.querySelector('code') || container.querySelector('pre');
            var text = codeArea ? codeArea.innerText : '';
            if(!text.trim()) { feedback(false, el); return; }
            var writeSucceeded = function(){ feedback(true, el); };
            var writeFailed = function(err){ console.error('Copy failed', err); feedback(false, el); };
            if(navigator.clipboard && navigator.clipboard.writeText){
              navigator.clipboard.writeText(text).then(writeSucceeded, writeFailed);
            } else {
              try {
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position='fixed';
                ta.style.top='-1000px';
                ta.style.opacity='0';
                document.body.appendChild(ta);
                ta.select();
                var ok = document.execCommand('copy');
                document.body.removeChild(ta);
                ok?writeSucceeded():writeFailed();
              } catch(e){ writeFailed(e); }
            }
          };

          function feedback(success, el){
            var icon = el.querySelector('i.mdui-icon');
            if(success){
              el.classList.add('copy-success');
              if(icon) icon.textContent='check_circle';
              // el._tooltip = new mdui.Tooltip(el, {content: '已复制！', position: 'top'});
              //el._tooltip.open();
              } else {
                el.classList.add('copy-fail');
                if(icon) icon.textContent='warning';
                el._tooltip = new mdui.Tooltip(el, {content: '复制失败！', position: 'top'});
                el._tooltip.open();
            }
            clearTimeout(el._copyTimer);
            el._copyTimer = setTimeout(function(){
              el.classList.remove('copy-success','copy-fail');
                if(icon) icon.textContent='content_copy';
                //el._tooltip.close();
                //el._tooltip = null;
            },3000);
          }

          function toggleCollapse(wrapper, btn){
            if(!wrapper) return;
            var content = wrapper.querySelector(':scope > .code-content-wrap');
            if(!content){
              wrapper.classList.toggle('collapsed');
              var icon = btn.querySelector('i.mdui-icon');
              if(wrapper.classList.contains('collapsed')) btn.setAttribute('aria-label','展开代码'); else btn.setAttribute('aria-label','折叠代码');
              return;
            }
            var isCurrentlyCollapsed = wrapper.classList.contains('collapsed');
            var willCollapse = !isCurrentlyCollapsed;
            wrapper.classList.toggle('collapsed', willCollapse);
            btn.setAttribute('aria-label', willCollapse ? '展开代码' : '折叠代码');


            var startHeight = content.scrollHeight;

            if(!willCollapse && (content.style.maxHeight === '0px')) {

              content.style.maxHeight = '0px';

              requestAnimationFrame(function(){
                content.style.maxHeight = startHeight + 'px';
              });
            } else if(willCollapse) {


              content.style.maxHeight = startHeight + 'px';

              void content.offsetWidth;

              requestAnimationFrame(function(){
                requestAnimationFrame(function(){
                  content.style.maxHeight = '0px';
                });
              });
            } else {

              content.style.maxHeight = startHeight + 'px';
            }

            content.removeEventListener('transitionend', content._collapseHandler || function(){});
            content._collapseHandler = function(ev){
              if(ev.propertyName !== 'max-height') return;
              if(!wrapper.classList.contains('collapsed')){

                content.style.maxHeight = content.scrollHeight + 'px';
              }
            };
            content.addEventListener('transitionend', content._collapseHandler);
          }

          attachCopyButtons();
          document.addEventListener('pjax:complete', attachCopyButtons);
          document.addEventListener('pjax:success', attachCopyButtons);
        })();
      </script>
      <style data-pjax>
        /* notbyai icon: placed to the right of the blockquote, centered vertically
           uses background-image so it responds to CSS color-scheme or body class
        */
        .notbyai-wrapper { gap: 12px; display: flex; flex-direction: row; align-items: center; }
        .notbyai-icons { display:flex; align-items:center; gap:8px; margin-left: auto; }
        @media (max-width: 768px) {
          .notbyai-wrapper {
            flex-direction: column;
            align-items: flex-start;
          }
          .notbyai-icons {
            margin-left: 0;
            margin-top: 12px;
          }
        }
        .notbyai-icons .notbyai-icon,
        .notbyai-icons .notbyai-extra {
          display: inline-block;
          width: 9.5121em; /* uniform size for all icons */
          height: 3em;
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center;
          flex: 0 0 auto;
        }
        /* any extra icons can be added with .notbyai-extra and will appear to the left of the main icon */
        .notbyai-icons .notbyai-extra { opacity: 0.95; }
        /* Default (light) main icon */
        .notbyai-icons .notbyai-icon { background-image: url('/images/notbyai-cn-light.svg'); }
        /* If page uses mdui dark class on body, switch main icon */
        body.mdui-theme-layout-dark .notbyai-icons .notbyai-icon { background-image: url('/images/notbyai-cn-dark.svg'); }
        @media (prefers-color-scheme: dark) {
          .notbyai-icons .notbyai-icon { background-image: url('/images/notbyai-cn-dark.svg'); }
        }

        /* Copy button base & layout */
  .codeblock-wrapper { overflow: hidden;transition: padding-bottom .35s cubic-bezier(.4,0,.2,1);}
  .codeblock-wrapper.codeblock-pad-top { padding-top: 36px; padding-bottom:0px; }
  .codeblock-wrapper.collapsed { padding-bottom:8px;transition: padding-bottom .35s cubic-bezier(.4,0,.2,1);  }
  /* Toolbar */
  .codeblock-wrapper .code-toolbar { position:absolute; top:6px; left:6px; display:flex; gap:8px; align-items:center; z-index:5; }
  .codeblock-wrapper .code-toolbar button { background:transparent; border-radius:6px; min-width:36px; height:32px; line-height:32px; padding:0 8px; box-shadow:none; text-transform:none; font-size:18px; display:inline-flex; align-items:center; justify-content:center; color:#000; transition:background-color .25s ease, color .25s ease; }
  .codeblock-wrapper .code-toolbar button i { font-size:20px; transition: transform .3s ease; }
  .mdui-theme-layout-dark .codeblock-wrapper .code-toolbar button { color:#fff; }
  .codeblock-wrapper .code-toolbar button:hover { background: rgba(0,0,0,0.06); }
  .mdui-theme-layout-dark .codeblock-wrapper .code-toolbar button:hover { background: #ffffff1f; }
  .codeblock-wrapper .code-toolbar .copy-btn.copy-success { background: #4caf504d;  color: #5ac18fff; }
  .mdui-theme-layout-dark .codeblock-wrapper .code-toolbar .copy-btn.copy-success { background: #4caf5059; }
  .codeblock-wrapper .code-toolbar .copy-btn.copy-fail { background: #ffeb3b73; color:#8d6e00; }
  .mdui-theme-layout-dark .codeblock-wrapper .code-toolbar .copy-btn.copy-fail { background: #ffeb3b8c; }
  .codeblock-wrapper .code-toolbar .collapse-btn i { transition: transform .3s ease; }
  .codeblock-wrapper.collapsed .code-toolbar .collapse-btn i { transform: rotate(180deg); }
  .codeblock-wrapper .code-toolbar .code-lang-badge { font-size:12px; line-height:1; padding:4px 8px; border-radius:6px; background:rgba(0,0,0,0.06); color:#000; user-select:none; cursor:default; opacity:.85; }
  .mdui-theme-layout-dark .codeblock-wrapper .code-toolbar .code-lang-badge { background:#ffffff24; color:#fff; }
  /* Animated content wrapper */
  .codeblock-wrapper .code-content-wrap { overflow:auto; transition: max-height .35s cubic-bezier(.4,0,.2,1); }
  .codeblock-wrapper.collapsed .code-content-wrap { max-height:0 !important; padding-top:0 !important; padding-bottom:0 !important; }
  /* Avoid hiding toolbar */
  .codeblock-wrapper.collapsed > .code-toolbar { display:flex !important; }
        .codeblock-wrapper .copy-btn.copy-success { background: #4caf504d; color:#2e7d32; }
        .mdui-theme-layout-dark .codeblock-wrapper .copy-btn.copy-success { background: #4caf5059; }
        .codeblock-wrapper .copy-btn.copy-fail { background: #ffeb3b73; color:#8d6e00; }
        .mdui-theme-layout-dark .codeblock-wrapper .copy-btn.copy-fail { background: #ffeb3b8c; }
  /* Legacy compatibility removal of old selectors kept intentionally empty */
      </style>
      <% if (is_post() && page.donate !== false && theme.donate && theme.donate.length) { %>
        <div class="mdui-m-y-2 mdui-text-center">
          <button class="mdui-fab mdui-color-deep-orange mdui-text-color-white mdui-ripple" mdui-dialog="{target: '#donate'}" mdui-tooltip="{content: '<%= __('donate') %>', position: 'top'}"><i class="mdui-icon material-icons" translate="no">thumb_up</i></button>
        </div>
      <% } %>
      <% if (is_post() && page.license != false) {%>
      <div class="notbyai-wrapper" style="display:flex;align-items:center;">
        <blockquote>
          <% if (page.license) { %>
            <strong><%- page.license %></strong><br>
          <% } else if (theme.license && page.license !== false) { %>
            <strong><%- theme.license %></strong><br>
          <% } %>
          <% if (!(page.thislink === false) ) {%>
            <strong><%= __('permalink') %></strong><br><a href="<%- page.permalink %>"><%- decodeURI(page.permalink) %></a>
          <% } %>
        </blockquote>
        <div class="notbyai-icons" aria-hidden="false">
          <!-- 可在这里添加额外图标，并放在主图标的左侧，示例：
               <span class="notbyai-extra" style="background-image: url('/images/extra.svg')" aria-hidden="true"></span>
          -->
          <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="" style="max-width: 1.8em;max-height:1.8em;margin-left: .08em;"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="" style="max-width: 1.8em;max-height:1.8em;margin-left: .08em;"><img src="https://mirrors.creativecommons.org/presskit/icons/nc.svg" alt="" style="max-width: 1.8em;max-height:1.8em;margin-left: .08em;"><img src="https://mirrors.creativecommons.org/presskit/icons/sa.svg" alt="" style="max-width: 1.8em;max-height:1.8em;margin-left: .08em;">
          <a href="//notbyai.fyi"><span class="notbyai-icon" role="img"></span></a>
        </div>
      </div>
      <% } %>
    </div>
    <footer class="mdui-card-actions">
      <% if (page.categories && page.categories.length) { %>
        <%- list_categories(page.categories, {show_count: false, style: 'none', separator: '', class: 'mdui-ripple article_categories'}) %>
      <% } %>
      <% if (page.tags && page.tags.length) { %>
        <%- list_tags(page.tags, {show_count: false, style: 'none', separator: '', class: {a: 'mdui-ripple article_tags-link'}}) %>
      <% } %>
    </footer>
    <% if (is_post() && page.donate !== false && theme.donate && theme.donate.length) { %>
      <div class="mdui-dialog" id="donate">
        <div class="mdui-tab mdui-tab-centered">
          <% for (var i in theme.donate) { %>
            <a href="#donate-<%= i %>" class="mdui-ripple"><%= theme.donate[i].name %></a>
          <% } %>
        </div>
        <% function is_image(str) { var filter = '.jpeg|.gif|.jpg|.png|.bmp|.pic|'; if (str.indexOf('.') > -1) { var pos = str.lastIndexOf('.'); var fix = str.substring(pos, str.length) + '|'; fix = fix.toLowerCase(); if (filter.indexOf(fix) > -1) return true; } return false; } %>
        <% for (var i in theme.donate) { %>
          <div id="donate-<%= i %>" class="mdui-p-a-2 mdui-typo mdui-text-center">
            <% if (is_image(theme.donate[i].link)) { %>
              <img src="<%- theme.donate[i].link %>" style="width: 300px;">
            <% } else { %>
              <a href="<%- theme.donate[i].link %>" target="_blank">>> <%= theme.donate[i].name %></a>
            <% } %>
          </div>
        <% } %>
      </div>
    <% } %>
  </article>
  <%- js([theme.gallery.jquery_js, theme.gallery.fancybox_js]) %>
  <script data-pjax>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>
<% } %>

<% if (page.comments && theme.comment.use) { %>
  <div id="comment" class="mdui-m-t-5">
    <!-- 占位提示：当评论区未正常加载时显示 -->
    <div id="comment-placeholder" style="padding:16px;color:#666;text-align:center;">若评论区未正常加载，请<a href="javascript:location.reload()">刷新此页</a></div>
    <%- partial('_widget/comment/' + theme.comment.use) %>
  </div>
  <script data-pjax>
    (function(){
      var commentEl = document.getElementById('comment');
      if(!commentEl) return;
      var placeholder = document.getElementById('comment-placeholder');

      function removePlaceholder(){
        try{
          if(placeholder && placeholder.parentNode){
            placeholder.parentNode.removeChild(placeholder);
            placeholder = null;
          }
        }catch(e){}
      }

      function widgetHasRendered(){
        // 如果除了占位元素外还有其他子节点且这些子节点包含有效内容，则视为已加载
        var children = Array.prototype.slice.call(commentEl.children || []).filter(function(c){ return c.id !== 'comment-placeholder'; });
        if(children.length === 0) return false;

        for(var i=0;i<children.length;i++){
          var c = children[i];
          // 常见的评论容器 id 或者非空节点即表示已渲染
          if(c.id === 'gitalk-container' || c.id === 'disqus_thread' || c.id === 'utterances' || c.querySelector('*')) return true;
          if(c.textContent && c.textContent.trim().length > 0) return true;
        }
        return false;
      }

      // 先做一次同步检查
      if(widgetHasRendered()){
        removePlaceholder();
        return;
      }

      // 监听后续变化：当评论脚本填充 DOM 时移除占位
      var obs = new MutationObserver(function(){
        try{
          if(widgetHasRendered()){
            removePlaceholder();
            obs.disconnect();
          }
        }catch(e){}
      });
      obs.observe(commentEl, {childList:true, subtree:true, characterData:true});

      // 作为保险：如果 20s 内仍未检测到加载，保留占位提示不作更多操作
      setTimeout(function(){ try{ obs.disconnect(); }catch(e){} }, 20000);
    })();
  </script>
<% } %>
<script data-pjax>
  (function(){
    // 将当前页面是否启用 toc 传给前端逻辑
    window.__page_has_toc__ = <%= is_post() && page.toc ? 'true' : 'false' %>;

    function buildTocFromHeadings() {
      // 清理旧的容器（如果存在）
      try {
        var old = document.getElementById('toc-fab-container');
        if (old && old.parentNode) old.parentNode.removeChild(old);
      } catch(e) {}

      if (!window.__page_has_toc__) return; // 未启用则直接返回

      var content = document.querySelector('#main article .mdui-card-content');
      if (!content) return;
      var headings = content.querySelectorAll('h2, h3, h4, h5, h6');
      if (!headings || headings.length === 0) return; // 无标题则不展示

      // 构建 TOC 列表（保持原有 .toc 结构样式）
      function getLevel(h){ var t = parseInt(h.tagName.replace('H',''), 10); return isNaN(t)?6:t; }
      var rootOl = document.createElement('ol');
      rootOl.className = 'toc';
      var currentLevel = 0;
      var currentOl = rootOl;
      var olStack = [rootOl];

      headings.forEach(function(h){
        if (!h.id) return; // 没有 id 的标题跳过
        var level = getLevel(h);
        if (currentLevel === 0) currentLevel = level; // 初始化基准层级

        if (level > currentLevel) {
          // 下钻：创建子 ol，直到匹配层级
          for (var i = currentLevel; i < level; i++) {
            var childOl = document.createElement('ol');
            childOl.className = 'toc-child';
            var lastLi = currentOl.lastElementChild;
            if (!lastLi) { lastLi = document.createElement('li'); currentOl.appendChild(lastLi); }
            lastLi.appendChild(childOl);
            olStack.push(childOl);
            currentOl = childOl;
          }
          currentLevel = level;
        } else if (level < currentLevel) {
          // 回退：弹栈到目标层级
          for (var j = currentLevel; j > level; j--) {
            olStack.pop();
          }
          currentOl = olStack[olStack.length - 1] || rootOl;
          currentLevel = level;
        }

        var li = document.createElement('li');
        li.className = 'toc-item toc-level-' + level;
        var a = document.createElement('a');
        a.className = 'toc-link';
        a.href = '#' + encodeURIComponent(h.id);
        var span = document.createElement('span');
        span.className = 'toc-text';
        span.textContent = h.textContent || h.innerText || '';
        a.appendChild(span);
        li.appendChild(a);
        currentOl.appendChild(li);
      });

      // 不生成空 TOC
      if (!rootOl.children.length) return;

      // 生成浮动按钮 + 菜单（保持原有样式）
      var container = document.createElement('div');
      container.id = 'toc-fab-container';
      container.setAttribute('aria-hidden', 'false');
      container.style.position = 'fixed';
      container.style.right = '16px';
      container.style.top = '30%';
      container.style.zIndex = '4999';

      var btn = document.createElement('button');
      btn.className = 'mdui-fab mdui-fab-mini mdui-ripple';
      btn.style.background = '#75757575';
      btn.setAttribute('mdui-menu', "{target: '#toc-menu'}");
      btn.setAttribute('aria-label', '目录');
      btn.innerHTML = '<i class="mdui-icon material-icons" translate="no">toc<\/i>';

      var menu = document.createElement('ul');
      menu.className = 'mdui-menu';
      menu.id = 'toc-menu';
      var liWrap = document.createElement('li');
      liWrap.className = 'mdui-menu-item';
      liWrap.setAttribute('disabled', '');
      liWrap.appendChild(rootOl);
      menu.appendChild(liWrap);

      container.appendChild(btn);
      container.appendChild(menu);
      document.body.appendChild(container);

      // 初始化 MDUI 组件
      try { if (window.mdui && typeof mdui.mutation === 'function') mdui.mutation(); } catch(e) {}

      // 点击目录项后关闭菜单（可选优化）
      menu.addEventListener('click', function(e){
        var a = e.target.closest('a.toc-link');
        if (!a) return;
        // 让 MDUI 菜单关闭
        try {
          var inst = mdui.Menu.get(btn);
          if (inst) inst.close();
        } catch(e) {}
      });
    }

    // 初次与 PJAX 切换后重建
    document.addEventListener('DOMContentLoaded', buildTocFromHeadings);
    document.addEventListener('page:updated', buildTocFromHeadings);
    document.addEventListener('pjax:complete', buildTocFromHeadings);
    document.addEventListener('pjax:success', buildTocFromHeadings);
  })();
</script>
<div class="mdui-divider" style="margin-bottom: 39px"></div>
<% if (page.prev || page.next) { %>
  <nav id="paginator">
    <% if (page.prev) { %>
      <a rel="prev" class="extend prev" href="<%- url_for(page.prev.path) %>" style="display:flex;align-items:center;gap:12px;">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_back</i></button>
        <span style="display:flex;flex-direction:column;align-items:flex-start;">
          <small class=" prev-title-responsive" style="font-size:12px;opacity:.7;">上一篇</small>
          <span class=" prev-title-responsive" style="display:block;padding-right:0px;"><%= page.prev.title %></span>
        </span>
      </a>
      <style>
        @media (max-width: 500px) {
          .prev-title-responsive {
            display: none !important;
          }
          
        }
      </style>
    <% } %>
    <div class="spacer"></div>
    <% if (page.next) { %>
      <a rel="next" class="extend next" href="<%- url_for(page.next.path) %>" style="display:flex;align-items:center;gap:12px;">
        <span style="display:flex;flex-direction:column;align-items:flex-end;text-align:right;">
          <small style="font-size:12px;opacity:.7;">下一篇</small>
          <span style="display:block;"><%= page.next.title %></span>
        </span>

        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_forward</i></button>
      </a>
    <% } %>
  </nav>
<% } %>
