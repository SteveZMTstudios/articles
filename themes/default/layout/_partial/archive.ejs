<% if (page.current === 1 && is_home() && theme.notice) { %>
  <article class="mdui-card mdui-m-b-5">
    <div class="mdui-card-content mdui-typo mdui-ripple" id="notice-container">
      <i class="mdui-icon material-icons mdui-text-color-deep-orange" translate="no">announcement</i> 
      
      <% if (Array.isArray(theme.notice)) { %>
        <span id="random-notice"></span>
        <script data-pjax>
          (function() {

            const NoticeSystem = {
              get isInitialized() {
                return localStorage.getItem('notice-system-initialized') === 'true';
              },
              set isInitialized(value) {
                localStorage.setItem('notice-system-initialized', value);
              },
              typing: false,
              typingTimeout: null,
              lastUsedNotice: -1
            };
          

            window.initNoticeSystem = function() {
              console.log('Initializing notice system...');
              
              const isHome = window.location.pathname === '/' || 
                            window.location.pathname === '/index.html';
              
              if (!isHome || NoticeSystem.typing) {
                console.log('Not initializing - not home or typing in progress');
                return;
              }
          
              const notices = <%- JSON.stringify(theme.notice) %>;
              const noticeElement = document.getElementById('random-notice');
              
              if (!noticeElement) {
                console.log('Notice element not found');
                return;
              }

              if (noticeElement.dataset.initialized === 'true') {
                return;
              }
              noticeElement.dataset.initialized = 'true';
          
              /*
               CSS-driven type effect:
               - 使用少量 JS 将文本节点按字符包裹为 <span class="notice-char" style="--i:idx">...
               - 通过 CSS animation + animation-delay 逐字符显示
               - 这样在回退/重复加载场景下更稳定，且不会拆坏 HTML 标签
              */

              function wrapNodeChars(node, outFragment, startIndexObj) {
                // startIndexObj: {i: number} 用于跨节点计数
                if (node.nodeType === Node.TEXT_NODE) {
                  var text = node.textContent || '';
                  for (var ci = 0; ci < text.length; ci++) {
                    var ch = text.charAt(ci);
                    var span = document.createElement('span');
                    span.className = 'notice-char';
                    span.style.setProperty('--i', startIndexObj.i);
                    // 保留空格可见性
                    if (ch === ' ') span.innerHTML = '&nbsp;'; else span.textContent = ch;
                    outFragment.appendChild(span);
                    startIndexObj.i++;
                  }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                  var clone = node.cloneNode(false);
                  var children = Array.from(node.childNodes);
                  children.forEach(function(child){
                    wrapNodeChars(child, clone, startIndexObj);
                  });
                  outFragment.appendChild(clone);
                }
              }

              function renderNoticeWithCss(html) {
                try {
                  // 解析 html 片段到临时容器
                  var temp = document.createElement('div');
                  temp.innerHTML = html;
                  var frag = document.createDocumentFragment();
                  var start = { i: 0 };
                  Array.from(temp.childNodes).forEach(function(n){ wrapNodeChars(n, frag, start); });

                  // 清空并插入
                  noticeElement.innerHTML = '';
                  noticeElement.appendChild(frag);
                  // 标记用于 CSS 动画（每次渲染都重触动画）
                  void noticeElement.offsetWidth;
                  noticeElement.classList.remove('notice-anim-play');
                  // 强制重排后添加类重新触发动画
                  setTimeout(function(){ noticeElement.classList.add('notice-anim-play'); }, 10);
                } catch (e) {
                  console.warn('renderNoticeWithCss error', e);
                  noticeElement.innerHTML = html;
                }
              }

              function displayRandomNotice() {
                if (!Array.isArray(notices) || notices.length === 0) return;
                var randomIndex = Math.floor(Math.random() * notices.length);
                if (randomIndex === NoticeSystem.lastUsedNotice && notices.length > 1) {
                  // pick another
                  randomIndex = (randomIndex + 1) % notices.length;
                }
                NoticeSystem.lastUsedNotice = randomIndex;
                renderNoticeWithCss(notices[randomIndex]);
              }


              const container = document.getElementById('notice-container');
              if (container && !NoticeSystem.isInitialized) {
                container.addEventListener('click', displayRandomNotice);
                NoticeSystem.isInitialized = true;
              }


              displayRandomNotice();
                // mark global-initialized to avoid duplicate re-inits from outer script
                try { window.__notice_initialized_once = true; } catch(e) {}
            };

            // Auto-init immediately
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', window.initNoticeSystem);
            } else {
              window.initNoticeSystem();
            }
          
          })();
          </script>
        <style data-pjax>
          /* Notice CSS-based type animation */
          /* 初始隐藏，避免服务器渲染内容或 PJAX 切换瞬显 */
          #random-notice { display:inline-block; line-height:1.45; opacity:0; }
          #random-notice.notice-anim-play { opacity:1; }
          #random-notice.notice-anim-play .notice-char { opacity:0; transform:translateY(-6px); display:inline-block; white-space:pre; }
          @keyframes notice-fade-in {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
          }
          #random-notice.notice-anim-play .notice-char {
            animation-name: notice-fade-in;
            animation-duration: 360ms;
            animation-fill-mode: forwards;
            animation-timing-function: cubic-bezier(.2,.8,.2,1);
            animation-delay: calc(var(--i) * 0.06s);
          }
        </style>
      <% } else { %>
        <%= theme.notice %>
      <% } %>
  </article>
<% } %>
<% if (is_archive()) { %>
  <div class="mdui-chip mdui-m-b-3">
    <span class="mdui-chip-icon mdui-color-theme-accent"><i class="mdui-icon material-icons" translate="no">place</i></span>
    <span class="mdui-chip-title"><%= __('archive') %>：<%= page.year %>/<%= page.month %></span>
  </div>
<% } %>
<% if (is_category()) { %>
  <div class="mdui-chip mdui-m-b-3">
    <span class="mdui-chip-icon mdui-color-theme-accent"><i class="mdui-icon material-icons" translate="no">place</i></span>
    <span class="mdui-chip-title"><%= __('category') %>：<%= page.category %></span>
  </div>
<% } %>
<% if (is_tag()) { %>
  <div class="mdui-chip mdui-m-b-3">
    <span class="mdui-chip-icon mdui-color-theme-accent"><i class="mdui-icon material-icons" translate="no">place</i></span>
    <span class="mdui-chip-title"><%= __('tag') %>：<%= page.tag %></span>
  </div>
<% } %>
<% page.posts.each(function (post) { %>
  <article class="mdui-card mdui-m-b-5 mdui-hoverable">
    <a href="<%- url_for(post.link || post.path) %>"<% if (post.link) { %> target="_blank"<% } %>>
      <header class="mdui-card-media mdui-ripple">
        <img src="<%- post.thumbnail || '/images/random/material-' + (Math.round(Math.random() * 18) + 1) + '.png' %>" style="max-height: 240px; width: 100%; object-fit: cover;" alt="thumbnails">
        <div class="mdui-card-media-covered">
          <div class="mdui-card-primary">
            <div class="mdui-card-primary-title"><%= post.title %></div>
            <div class="mdui-card-primary-subtitle"><i class="iconfont" translate="no">&#xe697;</i> <%- date(post.date) %> / <i class="iconfont" translate="no">&#xe601;</i> <%= post.author || config.author %></div>
          </div>
        </div>
        <% if (post.sticky || post.top) { %>
          <div class="mdui-card-menu">
            <button class="mdui-btn mdui-btn-icon mdui-text-color-white"><i class="mdui-icon material-icons" translate="no">fiber_pin</i></button>
          </div>
        <% } %>
      </header>
    </a>
    <div class="mdui-card-content mdui-typo">
      <% if (post.excerpt) { %>
        <%- strip_html(post.excerpt) %>……
      <% } else { %>
        <%- strip_html(truncate(post.content, {length: 120})) %>……
      <% } %>
    </div>
    <div class="mdui-text-center">
      <a href="<%- url_for(post.link || post.path) %>"<% if (post.link) { %> target="_blank"<% } %> class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-color-theme-accent mdui-ripple"><%= __('more') %></a>
    </div>
    <footer class="mdui-card-actions">
      <% if (post.categories && post.categories.length) { %>
        <%- list_categories(post.categories, {show_count: false, style: 'none', separator: '', class: 'mdui-ripple article_categories'}) %>
      <% } %>
      <% if (post.tags && post.tags.length) { %>
        <%- list_tags(post.tags, {show_count: false, style: 'none', separator: '', class: {a: 'mdui-ripple article_tags-link'}}) %>
      <% } %>
    </footer>
  </article>
<% }) %>
<% if (page.total > 1) { %>
  <nav id="paginator">
    <%- paginator({
      prev_text: '<button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_back</i></button>',
      next_text: '<button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_forward</i></button>',
      escape: false,
      space: ''
    }) %>
  </nav>
<% } %>
