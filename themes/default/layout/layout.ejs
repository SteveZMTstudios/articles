<!DOCTYPE html>
<html lang="<%= page.lang %>">
<%- partial('_partial/head') %>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-<%= theme.theme_color.primary || 'indigo' %> mdui-theme-accent-<%= theme.theme_color.accent || 'pink' %>">
  <% if (theme.comment && theme.comment.use === 'gitalk' && theme.comment.gitalk_js) { %>
  <script>window.GITALK_SRC = '<%- theme.comment.gitalk_js %>';</script>
  <% } %>
  <% if (theme.busuanzi.site || theme.busuanzi.page) { %>
  <script>window.BUSUANZI_SRC = '<%- theme.busuanzi.busuanzi_js %>';</script>
  <% } %>
  <script src="//awp-assets.meituan.net/thh/thh_feb_web_portal/js/jquery-3.6.0.min.js"></script>
  <script>
    if (typeof jQuery === 'undefined') {
      document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"><\/script>');
    }
  </script>
  <script>
/* //console.log -> console.log */

    function __normalizeGitalkId(raw) {
      try {
        if (!raw) raw = location.pathname;
        if (/^https?:\/\//i.test(raw)) {
          var u = new URL(raw, window.location.origin);
          raw = u.pathname || '/';
        }
        try { raw = decodeURI(raw); } catch (e) {}
        raw = raw.replace(/index\.html$/i, '');
        if (raw && raw.charAt(0) !== '/') raw = '/' + raw;
        if (raw.length > 1 && raw.endsWith('/')) raw = raw.slice(0, -1);
        return raw || '/';
      } catch (e) {
        return (window.location && window.location.pathname) || '/';
      }
    }

    function triggerEvents() {
      document.dispatchEvent(new Event('DOMContentLoaded'));
      document.dispatchEvent(new Event('readystatechange'));
      window.dispatchEvent(new Event('load'));
      window.dispatchEvent(new Event('scroll'));
      window.dispatchEvent(new Event('resize'));
      window.dispatchEvent(new Event('orientationchange'));
      window.dispatchEvent(new Event('focus'));
      document.hasFocus() && document.activeElement && document.activeElement.focus();
  }

    function reinitPageComponents() {
      if (typeof window.initNoticeSystem === 'function') {
        try {
          window.initNoticeSystem();
        } catch (e) {
          console.warn('NoticeSystem reinit error:', e);
        }
      }
      if (window.GITALK_SRC && document.getElementById('gitalk-container')) {
        if (typeof Gitalk === 'undefined') {
          var script = document.createElement('script');
          script.src = window.GITALK_SRC;
          script.onload = function() {
            setTimeout(initGitalk, 100);
          };
          document.body.appendChild(script);
        } else {
          setTimeout(initGitalk, 100);
        }
      }
    }

    function initGitalk() {
      if (!window.Gitalk) return;
      var el = document.getElementById('gitalk-container');
      if (!el) return;
      var config = window.GITALK_CONFIG || {};
      if (!config.repo || !config.owner) {
        if (window.theme && window.theme.comment) {
          config = Object.assign({}, window.theme.comment);
        }
      }
      try {
        config.id = __normalizeGitalkId(config.id || (window.location && window.location.pathname));
      } catch (e) {}
      if (!config.repo || !config.owner) {
        el.innerHTML = '<div style="color:red">Gitalk 配置错误: repo/owner 未设置</div>';
        return;
      }
      el.innerHTML = '';
      var gitalk = new Gitalk(config);
      gitalk.render('gitalk-container');
      window.GITALK_CONFIG = config;
    }


    document.addEventListener('page:updated', function() {
      setTimeout(function() {
        triggerEvents();
        reinitPageComponents();
      }, 50);
    });


    window.addEventListener('load', function() {
      setTimeout(function() {
        reinitPageComponents();
        try { fixMduiDialogs(); fixFixedElements(); } catch(e) {}
      }, 50);

  try { window._pjax_last_url = location.href; } catch(e) {}
    });
    

    function handleDrawer() {
      try {
        const drawer = document.querySelector('.mdui-drawer');
        if (drawer) {
          const $ = mdui.$;
          const inst = new mdui.Drawer(drawer);
          const isMobile = window.innerWidth < 1024;
          const menuButtonnw = document.querySelector('.mdui-btn-icon');
          if (menuButtonnw && inst.getState() === 'opened' && isMobile) {
            menuButtonnw.click();
          }
          const isForceClose = localStorage.getItem('mdui-drawer-close');
          /**
          if (isMobile || isForceClose) {
            inst.close();
            $('.mdui-overlay.mdui-overlay-show').remove();
            $('body').css('overflow', 'auto');
            
          }
            */
        }
      } catch (err) {
        console.warn('处理抽屉导航失败:', err);
        alert('处理抽屉导航失败，请刷新页面');
      }
    }

    function reinitializeNoticeSystem() {
      try {
        if (typeof window.initNoticeSystem !== 'function') return;
        var isHome = (window.location.pathname === '/' || window.location.pathname === '/index.html');
        if (!isHome) return;
        if (window.__notice_initialized_once) return;
        window.__notice_initialized_once = true;
        window.initNoticeSystem();
      } catch (e) {
        console.warn('reinitializeNoticeSystem error:', e);
      }
    }


    function fixMduiDialogs() {
      // 避免重复绑定：对每个触发器仅绑定一次
      document.querySelectorAll('[mdui-dialog]').forEach(function(el) {
        try {
          if (el.dataset.dialogBound === '1') return;

          var dialogTarget = el.getAttribute('mdui-dialog') || '';
          var dialogId = '';

          try {
            var match = /target\s*:\s*['"]#?([^'"]+)['"]/i.exec(dialogTarget);
            if (match && match[1]) dialogId = match[1];
            else if (dialogTarget && dialogTarget.startsWith('#')) dialogId = dialogTarget.substring(1);
          } catch(e) {}

          if (!dialogId) return;

          var handler = function(e){
            try {
              e.preventDefault();
              e.stopPropagation();
            } catch(_) {}
            var dialog = document.getElementById(dialogId);
            if (dialog && dialog.parentNode !== document.body) {
              try { document.body.appendChild(dialog); } catch(_) {}
            }
            if (dialog && window.mdui && mdui.Dialog) {
              try {
                var inst = new mdui.Dialog(dialog, { history: false });
                inst.open();
              } catch(_) {}
            }
            return false;
          };

          // 记录并绑定一次
          el.__mduiDialogHandler = handler;
          el.addEventListener('click', handler, false);
          el.dataset.dialogBound = '1';
        } catch (e) { /* noop */ }
      });
    }

    function fixFixedElements() {
      try {
        // Known fixed element ids we want to manage (add more ids here if needed)
        var ids = ['toc'];
        ids.forEach(function(id) {
          var moved = document.querySelector('[data-fixed-wrapper-id="' + id + '"]');
          var newEl = document.querySelector('#main #' + id);

          // If we previously moved a wrapper but current page has no #main copy,
          // hide the moved wrapper instead of removing it. This avoids permanently
          // deleting the element (which prevents it from reappearing later).
          if (moved && !newEl) {
            try { moved.setAttribute('data-fixed-hidden', 'true'); moved.style.display = 'none'; } catch(e) { }
          }

          // If both exist but moved is not the wrapper for newEl, it's probably stale
          if (moved && newEl) {
            var newWrapper = newEl.closest('div');
            if (newWrapper && moved !== newWrapper) {
              try { moved.setAttribute('data-fixed-hidden', 'true'); moved.style.display = 'none'; } catch(e) { }
              moved = null;
            }
          }

          // If new element exists, move it to body (if required)
          if (newEl) {
            var wrapper = newEl.closest('div');
              if (wrapper) {
                var pos = '';
                try { pos = getComputedStyle(wrapper).position || wrapper.style.position; } catch(e) {}
                if (pos === 'fixed' && wrapper.parentNode !== document.body) {
                  wrapper.setAttribute('data-fixed-wrapper-id', id);
                  wrapper.removeAttribute('data-fixed-hidden');
                  wrapper.style.display = '';
                  document.body.appendChild(wrapper);
                } else if (pos === 'fixed' && wrapper.parentNode === document.body) {
                  // Ensure we set the attribute when it's already in the body
                  if (!wrapper.hasAttribute('data-fixed-wrapper-id')) wrapper.setAttribute('data-fixed-wrapper-id', id);
                  wrapper.removeAttribute('data-fixed-hidden');
                  wrapper.style.display = '';
                }
                // After moving or ensuring the wrapper is in body, re-run MDUI mutation
                try { if (window.mdui && typeof mdui.mutation === 'function') mdui.mutation(); } catch(e) {}
              }
          }
        });

        // For any wrappers previously moved to body, hide them if current #main
        // doesn't contain the corresponding element. Do not remove them permanently.
        document.querySelectorAll('[data-fixed-wrapper-id]').forEach(function(w) {
          var id = w.getAttribute('data-fixed-wrapper-id');
          if (id && !document.querySelector('#main #' + id)) {
            try { w.setAttribute('data-fixed-hidden', 'true'); w.style.display = 'none'; } catch(e) {}
          }
        });
      } catch (e) {
        console.warn('fixFixedElements error:', e);
      }
    }

    function simulatePageRefresh() {
      window.scrollTo(0, 0);
      triggerEvents();
      handleDrawer();
      window.dispatchEvent(new Event('page:updated'));
      reinitializeNoticeSystem();
      setTimeout(function(){
        fixMduiDialogs();
        fixFixedElements();
        // 降低图片对首屏渲染的阻塞
        try {
          document.querySelectorAll('#main img').forEach(function(img){
            if (!img.hasAttribute('loading')) img.setAttribute('loading','lazy');
            if (!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
          });
        } catch(_) {}
      }, 100);
    }


    function showLoading() {
      if (window.showMaterialRefresh) window.showMaterialRefresh();
      let progressBar = document.querySelector('.loading-progress');
      if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.className = 'mdui-progress loading-progress';
        const inner = document.createElement('div');
        inner.className = 'mdui-progress-indeterminate';
        progressBar.appendChild(inner);
        document.body.insertBefore(progressBar, document.body.firstChild);
      }
      progressBar.style.display = 'block';
      try {
        var mainEl = document.getElementById('main');
        if (mainEl) {
          mainEl.classList.remove('pjax-enter');
          // 添加退出类，触发 CSS 过渡
          mainEl.classList.add('pjax-exit');
        }
      } catch (e) {}
    }

    function hideLoading() {
      if (window.hideMaterialRefresh) window.hideMaterialRefresh();
      const progressBar = document.querySelector('.loading-progress');
      if (progressBar) {
        progressBar.style.display = 'none';
      }
      try {
        var mainEl2 = document.getElementById('main');
        if (mainEl2) {
          // 移除退出类，添加进入类以进行淡入动画
          mainEl2.classList.remove('pjax-exit');
          mainEl2.classList.add('pjax-enter');
          // 在过渡结束后清理 enter 类，避免堆积类名
          setTimeout(function() {
            try { mainEl2.classList.remove('pjax-enter'); } catch(e) {}
          }, 420);
        }
      } catch (e) {}
    }

    function handleAjaxError(errorType, link, href) {
  console.error(`页面加载失败: ${errorType}`, { href: href, link: link });
      mdui.snackbar({
        message: `页面加载失败，(${errorType})`,
        timeout: 1500,
        onClose: function() {

          window.location.reload();
        }
      });
    }

    function handleAjaxSuccess(response, href, targetHash) {
      try {
        //console.log('handleAjaxSuccess start', { href: href, targetHash: targetHash });
        const $response = $(response);
        const $newContent = $response.find('#main');
        const $mainContent = $newContent.length ? $newContent : $response.filter('#main');

        if (!$mainContent.length) {
          console.warn('handleAjaxSuccess: 未找到 #main 内容', { href: href, responseSample: response.slice? response.slice(0,200): undefined });
          if (href.endsWith('/') || href.endsWith('/index.html')) {
            window.location.reload();
            return;
          }
          console.error('无法找到内容区域，响应内容:', response);
          throw new Error('无法找到目标内容');
        }

        $('#main script[src*="gitalk"]').remove();

        $('#main').html($mainContent.html());

        // 低优先级执行器：让首屏渲染、动画先于脚本执行
        var scheduleLowPriority = (window.requestIdleCallback)
          ? function(fn){ try{ requestIdleCallback(fn, {timeout: 800}); }catch(_){ setTimeout(fn, 0); } }
          : function(fn){ setTimeout(fn, 0); };

        // 延后执行 data-pjax 内联脚本，避免阻断过渡动画
        scheduleLowPriority(function(){
          try {
            document.querySelectorAll('#main script[data-pjax]').forEach(function(item){
              var newScript = document.createElement('script');
              Array.from(item.attributes).forEach(function(attr){ newScript.setAttribute(attr.name, attr.value); });
              var content = item.text || item.textContent || item.innerHTML || '';
              if (content) newScript.appendChild(document.createTextNode(content));
              item.parentNode.replaceChild(newScript, item);
            });
          } catch(_) {}
        });

        var newGitalkConfigScript = $mainContent.find('script').filter(function() {
          return this.textContent && this.textContent.includes('window.GITALK_CONFIG');
        });
        if (newGitalkConfigScript.length) {
          try { eval(newGitalkConfigScript.text()); } catch(e) {console.warn('GITALK_CONFIG eval error', e);}        
        }

        try {
          if (window.GITALK_CONFIG) {
            var __targetPath = new URL(href, window.location.origin).pathname;
            window.GITALK_CONFIG.id = __normalizeGitalkId(window.GITALK_CONFIG.id || __targetPath);
          }
        } catch(e) { console.warn('Normalize Gitalk id failed', e); }

        // 延后加载外部脚本，默认使用 defer，减轻主线程阻塞
        scheduleLowPriority(function(){
          try {
            $mainContent.find('script[src]').each(function() {
              var src = this.getAttribute('src');
              if (src && !document.querySelector('script[src="'+src+'"]')) {
                var extScript = document.createElement('script');
                extScript.src = src;
                extScript.defer = true; // 优先使用 defer
                if (this.async) extScript.async = true;
                document.body.appendChild(extScript);
              }
            });
          } catch(_) {}
        });

        if (!window._popstate_handling) {
          history.pushState({}, '', href);
          try { window._pjax_last_url = href; } catch(e) {}
        }
        document.title = $response.filter('title').text() || document.title;
        simulatePageRefresh();

        // 提高 #main 首屏交互性：优先解除 loading，与动画同步
        hideLoading();

        // busuanzi 放低优先级加载
        scheduleLowPriority(function(){
          try {
            var busuanziScriptSelector = 'script[src*="busuanzi"]';
            var oldBusuanzi = document.querySelector(busuanziScriptSelector);
            if (oldBusuanzi && oldBusuanzi.parentNode) oldBusuanzi.parentNode.removeChild(oldBusuanzi);
            if (window.BUSUANZI_SRC) {
              var script = document.createElement('script');
              script.src = window.BUSUANZI_SRC;
              script.defer = true;
              document.body.appendChild(script);
            }
          } catch(_) {}
        });

  if (targetHash) {
          const target = $(targetHash);
          if (target.length) {
            $('html, body').animate({
              scrollTop: target.offset().top - 60
            }, 300);
          }
        }
      } catch (err) {
        window.location.reload();
        handleAjaxError('switch_error', null, href);

      }
    }

    function handleLinkClick(e, link, href, hashIndex, currentPath, targetPath) {
      //console.log('handleLinkClick', { href: href, hashIndex: hashIndex, currentPath: currentPath, targetPath: targetPath, linkClasses: link.attr('class') });


      try {
        var normalizePathname = function(p) {
          if (!p) return '/';
          p = String(p);
          if (p.length > 1 && p.endsWith('/')) return p.slice(0, -1);
          return p;
        };
        if (hashIndex === 0) {

          //console.log('handleLinkClick: pure hash - allow native', { href: href });
          if (e && typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
          return true;
        }
        if (normalizePathname(currentPath) === normalizePathname(targetPath)) {

          //console.log('handleLinkClick: same normalized path - allow native', { currentPath: currentPath, targetPath: targetPath });
          if (e && typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
          return true;
        }
      } catch (err) {

      }
      if (link.find('.mdui-icon.material-icons').text() === 'search' || !href || typeof href !== 'string' || href.startsWith('javascript:') || link.attr('data-no-pjax') === 'true') {
        //console.log('handleLinkClick: ignored (search/invalid)', { href: href });
        return true;
      }
      if (link.prop('host') === window.location.host && !link.attr('target') && link.attr('target') !== '_blank' && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
        //console.log('handleLinkClick: intercepting for PJAX', { href: href });
        e.preventDefault();
        showLoading();
        const targetUrl = hashIndex > -1 ? href.substring(0, hashIndex) : href;
        const targetHash = hashIndex > -1 ? href.substring(hashIndex) : '';
        //console.log('handleLinkClick: ajax target', { targetUrl: targetUrl, targetHash: targetHash });
        // Use fetch-based pjax wrapper for better control (fall back to ajax if needed)
        try {
          pjaxFetch(targetUrl, targetHash);
        } catch(e) {
          // fallback to existing AJAX on older browsers
          $.ajax({
            url: targetUrl,
            method: 'GET',
            dataType: 'html',
            success: function(response) {
              handleAjaxSuccess(response, href, targetHash);
            },
            error: function(xhr, status, error) {
              console.error('AJAX error', { status: status, error: error, href: href });
              handleAjaxError('ajax_error', link, href);
            }
          });
        }
      }
    }

    function pjaxFetch(href, targetHash, options) {
      options = options || {};
      showLoading();
      fetch(href, { credentials: 'same-origin' }).then(function(res) {
        if (!res.ok) throw new Error('Network response was not ok');
        return res.text();
      }).then(function(html) {
        try {
          handleAjaxSuccess(html, href, targetHash);
        } catch (e) {
          console.error('PJAX parse error', e);
          handleAjaxError('parse_error', null, href);
        }
      }).catch(function(err) {
        console.error('PJAX fetch failed', err, href);
        handleAjaxError('ajax_error', null, href);
      });
    }

    $(document).on('click', 'a', function(e) {
      const link = $(this);
      const href = link.attr('href');
  //console.log("document click a:", { href: href, classes: link.attr('class'), text: link.text() });

      if (href && href.startsWith('#mdui-dialog')) {
        e.preventDefault();
        var dialogId = href.replace('#', '');
        var dialog = document.getElementById(dialogId);
        if (dialog && window.mdui && mdui.Dialog) {
          var inst = new mdui.Dialog(dialog);
          inst.open();
        }
        return false;
      }
      const hashIndex = href ? href.indexOf('#') : -1;
      const currentPath = window.location.pathname;
      const targetPath = new URL(href, window.location.origin).pathname;
      handleLinkClick(e, link, href, hashIndex, currentPath, targetPath);
    });

    window.onpopstate = function(event) {
      //console.log('onpopstate triggered, location:', location.href, 'last_pjax:', window._pjax_last_url);
      try {
        var last = window._pjax_last_url || document.location.href;
        var newPath = new URL(location.href, window.location.origin).pathname;
        var lastPath = new URL(last, window.location.origin).pathname;
        var newHash = new URL(location.href, window.location.origin).hash;
        if (newPath === lastPath) {
          //console.log('onpopstate: same pathname, only hash changed — skip AJAX', { newHash: newHash });

          if (newHash) {
            var resolveHashTarget = function(hash) {
              try {
                if (!hash) return null;
                var raw = hash.charAt(0) === '#' ? hash.slice(1) : hash;

                try {
                  var decoded = decodeURIComponent(raw);
                } catch (e) {
                  decoded = raw;
                }
                if (decoded) {
                  var byId = document.getElementById(decoded);
                  if (byId) return byId;
                }

                if (window.CSS && typeof window.CSS.escape === 'function') {
                  try {
                    var sel = '#' + CSS.escape(raw);
                    var q = document.querySelector(sel);
                    if (q) return q;
                  } catch (e) {

                  }
                }

                try {
                  return document.querySelector(hash);
                } catch (e) {
                  return null;
                }
              } catch (e) {
                return null;
              }
            };
            var target = resolveHashTarget(newHash);
            if (target) {
              setTimeout(function(){ target.scrollIntoView(); }, 10);
            }
          }
          return;
        }
      } catch (e) { console.warn('onpopstate check failed', e); }

      //console.log('onpopstate: performing PJAX fetch for', location.href);
      showLoading();
      window._popstate_handling = true;
      var href = location.href;
      try {
        pjaxFetch(href, null, {popstate: true});
        window._popstate_handling = false;
        try { window._pjax_last_url = href; } catch(e) {}
      } catch (e) {
        // fallback to ajax request if pjaxFetch unsupported
        $.ajax({
          url: href,
          method: 'GET',
          dataType: 'html',
          success: function(response) {
            handleAjaxSuccess(response, href, null);
            window._popstate_handling = false;
            try { window._pjax_last_url = href; } catch(e) {}
          },
          error: function(xhr, status, error) {
            handleAjaxError('br_ajax_error', $(location), href);
            window._popstate_handling = false;
          }
        });
      }
    };
  </script>
  <script>if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <script>var a=localStorage.getItem("mdui-drawer-close");if(!a){document.getElementsByTagName("body")[0].className+=" mdui-drawer-body-left"};</script>
  <%- partial('_partial/header', null, {cache: !config.relative_link}) %>
  <%- partial('_partial/sidebar', null, {cache: !config.relative_link}) %>
  <main id="main" class="mdui-m-t-5 fadeIn animated"><%- body %></main>
  <%- partial('_partial/footer', null, {cache: !config.relative_link}) %>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_upward</i></button>
  <% if (theme.busuanzi.site || theme.busuanzi.page) { %><script data-pjax defer src="<%- theme.busuanzi.busuanzi_js %>"></script><% } %>
  <%- js(['js/mdui', 'js/script']) %>
  <%- js('custom') %>
  <%- js('js/sw-update') %>
</body>
</html>