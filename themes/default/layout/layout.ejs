<!DOCTYPE html>
<html lang="<%= page.lang %>">
<%- partial('_partial/head') %>
<body class="mdui-appbar-with-toolbar mdui-theme-primary-<%= theme.theme_color.primary || 'indigo' %> mdui-theme-accent-<%= theme.theme_color.accent || 'pink' %>">
  <% if (theme.comment && theme.comment.use === 'gitalk' && theme.comment.gitalk_js) { %>
  <script>window.GITALK_SRC = '<%- theme.comment.gitalk_js %>';</script>
  <% } %>
  <% if (theme.busuanzi.site || theme.busuanzi.page) { %>
  <script>window.BUSUANZI_SRC = '<%- theme.busuanzi.busuanzi_js %>';</script>
  <% } %>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    function triggerEvents() {
      document.dispatchEvent(new Event('DOMContentLoaded'));
      document.dispatchEvent(new Event('readystatechange'));
      window.dispatchEvent(new Event('load'));
      window.dispatchEvent(new Event('scroll'));
      window.dispatchEvent(new Event('resize'));
      window.dispatchEvent(new Event('orientationchange'));
      window.dispatchEvent(new Event('focus'));
      document.hasFocus() && document.activeElement && document.activeElement.focus();
    }

    function handleDrawer() {
      try {
        const drawer = document.querySelector('.mdui-drawer');
        if (drawer) {
          const $ = mdui.$;
          const inst = new mdui.Drawer(drawer);
          const isMobile = window.innerWidth < 1024;
          const menuButtonnw = document.querySelector('.mdui-btn-icon');
          if (menuButtonnw && inst.getState() === 'opened' && isMobile) {
            menuButtonnw.click();
          }
          const isForceClose = localStorage.getItem('mdui-drawer-close');
          /**
          if (isMobile || isForceClose) {
            inst.close();
            $('.mdui-overlay.mdui-overlay-show').remove();
            $('body').css('overflow', 'auto');
            
          }
            */
        }
      } catch (err) {
        console.warn('处理抽屉导航失败:', err);
        alert('处理抽屉导航失败，请刷新页面');
      }
    }

    function reinitializeNoticeSystem() {
      if (localStorage.getItem('notice-system-initialized') === 'true') {
        const noticeElement = document.getElementById('random-notice');
        if (noticeElement && (window.location.pathname === '/' || window.location.pathname === '/index.html')) {
          console.log('Reinitializing notice system');
          window.initNoticeSystem();
        }
      }
      if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
        if (typeof window.initNoticeSystem === 'function') {
          window.initNoticeSystem();
        }
      }
    }

    function simulatePageRefresh() {
      window.scrollTo(0, 0);
      triggerEvents();
      handleDrawer();
      window.dispatchEvent(new Event('page:updated'));
      if (typeof window.initNoticeSystem === 'function') {
        window.initNoticeSystem();
      }
      reinitializeNoticeSystem();
      console.log('Page type:', window.location.pathname);
      console.log('Notice system status:', window.noticeSystemInitialized);
    }

    function showLoading() {
      let progressBar = document.querySelector('.loading-progress');
      if (!progressBar) {
        progressBar = document.createElement('div');
        progressBar.className = 'mdui-progress loading-progress';
        const inner = document.createElement('div');
        inner.className = 'mdui-progress-indeterminate';
        progressBar.appendChild(inner);
        document.body.insertBefore(progressBar, document.body.firstChild);
      }
      progressBar.style.display = 'block';
    }

    function hideLoading() {
      const progressBar = document.querySelector('.loading-progress');
      if (progressBar) {
        progressBar.style.display = 'none';
      }
    }

    function handleAjaxError(errorType, link, href) {
      console.error(`页面加载失败: ${errorType}`);
      mdui.snackbar({
        message: `页面加载失败，(${errorType})`,
        timeout: 1500,
        onClose: function() {
          window.location.href = href;
        }
      });
    }

    function handleAjaxSuccess(response, href, targetHash) {
      try {
        const $response = $(response);
        const $newContent = $response.find('#main');
        const $mainContent = $newContent.length ? $newContent : $response.filter('#main');
        if (!$mainContent.length) {
          console.error('无法找到内容区域，响应内容:', response);
          throw new Error('无法找到目标内容');
        }
        // 1. 移除 #main 内的 gitalk 脚本，防止重复插入
        $('#main script[src*="gitalk"]').remove();
        // 2. 插入新内容
        $('#main').html($mainContent.html());
        // 3. 重新执行 #main 内的内联 script 标签（不处理外部src）
        $('#main script').each(function() {
          if (!this.src) {
            const oldScript = this;
            const newScript = document.createElement('script');
            newScript.text = oldScript.text || oldScript.innerHTML;
            if (oldScript.type) newScript.type = oldScript.type;
            Array.from(oldScript.attributes).forEach(attr => {
              if (attr.name !== 'type') {
                newScript.setAttribute(attr.name, attr.value);
              }
            });
            oldScript.parentNode.replaceChild(newScript, oldScript);
          }
        });
        // 4. 只在用户点击时 pushState，popstate 不再 pushState
        if (!window._popstate_handling) {
          history.pushState({}, '', href);
        }
        document.title = $response.filter('title').text() || document.title;
        simulatePageRefresh();
        // busuanzi 重新加载（强制重新插入脚本）
        var busuanziScriptSelector = 'script[src*="busuanzi"]';
        var oldBusuanzi = document.querySelector(busuanziScriptSelector);
        if (oldBusuanzi) {
          oldBusuanzi.parentNode.removeChild(oldBusuanzi);
        }
        if (window.BUSUANZI_SRC) {
          var script = document.createElement('script');
          script.src = window.BUSUANZI_SRC;
          script.defer = true;
          document.body.appendChild(script);
        }
        // gitalk 重新加载（如果有）
        var gitalkContainer = document.getElementById('gitalk-container');
        if (gitalkContainer) {
          function renderGitalk() {
            try {
              var gitalkConfig = window.gitalkConfig || {};
              var gitalk = new Gitalk(gitalkConfig);
              gitalk.render('gitalk-container');
            } catch(e) {console.warn('Gitalk reload failed:', e);}
          }
          if (typeof Gitalk === 'function') {
            setTimeout(renderGitalk, 100); // 延迟，确保脚本已加载
          } else if (window.GITALK_SRC && !document.querySelector('script[src="'+window.GITALK_SRC+'"]')) {
            var gtScript = document.createElement('script');
            gtScript.src = window.GITALK_SRC;
            gtScript.onload = renderGitalk;
            document.body.appendChild(gtScript);
          }
        }
        if (targetHash) {
          const target = $(targetHash);
          if (target.length) {
            $('html, body').animate({
              scrollTop: target.offset().top - 60
            }, 300);
          }
        }
        hideLoading();
      } catch (err) {
        handleAjaxError('switch_error', null, href);
      }
    }

    function handleLinkClick(e, link, href, hashIndex, currentPath, targetPath) {
      if (hashIndex === 0 || currentPath === targetPath) {
        return true;
      }
      if (link.find('.mdui-icon.material-icons').text() === 'search' || !href || typeof href !== 'string' || href.startsWith('javascript:')) {
        return true;
      }
      if (link.prop('host') === window.location.host && !link.attr('target') && link.attr('target') !== '_blank' && !e.ctrlKey && !e.shiftKey && !e.metaKey) {
        e.preventDefault();
        showLoading();
        const targetUrl = hashIndex > -1 ? href.substring(0, hashIndex) : href;
        const targetHash = hashIndex > -1 ? href.substring(hashIndex) : '';
        $.ajax({
          url: targetUrl,
          method: 'GET',
          dataType: 'html',
          success: function(response) {
            handleAjaxSuccess(response, href, targetHash);
          },
          error: function(xhr, status, error) {
            handleAjaxError('ajax_error', link, href);
          }
        });
      }
    }

    $(document).on('click', 'a', function(e) {
      const link = $(this);
      const href = link.attr('href');
      const hashIndex = href ? href.indexOf('#') : -1;
      const currentPath = window.location.pathname;
      const targetPath = new URL(href, window.location.origin).pathname;
      handleLinkClick(e, link, href, hashIndex, currentPath, targetPath);
    });

    window.onpopstate = function() {
      showLoading();
      window._popstate_handling = true;
      var href = location.href;
      $.ajax({
        url: href,
        method: 'GET',
        dataType: 'html',
        success: function(response) {
          handleAjaxSuccess(response, href, null);
          window._popstate_handling = false;
        },
        error: function(xhr, status, error) {
          handleAjaxError('br_ajax_error', $(location), href);
          window._popstate_handling = false;
        }
      });
    };
  </script>
  <script>if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <script>var a=localStorage.getItem("mdui-drawer-close");if(!a){document.getElementsByTagName("body")[0].className+=" mdui-drawer-body-left"};</script>
  <%- partial('_partial/header', null, {cache: !config.relative_link}) %>
  <%- partial('_partial/sidebar', null, {cache: !config.relative_link}) %>
  <main id="main" class="mdui-m-t-5 fadeIn animated"><%- body %></main>
  <%- partial('_partial/footer', null, {cache: !config.relative_link}) %>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons" translate="no">arrow_upward</i></button>
  <% if (theme.busuanzi.site || theme.busuanzi.page) { %><script defer src="<%- theme.busuanzi.busuanzi_js %>"></script><% } %>
  <%- js(['js/mdui', 'js/script']) %>
  <%- js('custom') %>
</body>
</html>